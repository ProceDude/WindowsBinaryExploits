
SRCS := $(wildcard *.c)

TARGETS_GCC :=
TARGETS_VS :=

#gcc 64 bits
TARGETS_GCC := $(TARGETS_GCC) $(patsubst %.c,%_gcc_64.exe,$(SRCS))
#gcc 32 bits
TARGETS_GCC := $(TARGETS_GCC) $(patsubst %.c,%_gcc_32.exe,$(SRCS))
#vs 64 bits
TARGETS_VS := $(TARGETS_VS) $(patsubst %.c,%_vs_64.exe,$(SRCS))
#vs 32 bits
TARGETS_VS := $(TARGETS_VS) $(patsubst %.c,%_vs_32.exe,$(SRCS))

# PDBs
DEBUG_FILES := $(patsubst %.exe,%.pdb,$(TARGETS_VS))

#-z execstack is not present on windows (see notes, week 1)
GCC_FLAGS := -g -O0 -Wall \
	-no-pie -fno-pic -fno-stack-protector -fcf-protection=none

# Od optimizations disabled
# Wall max warning level
# Zi debug info in pdb, Z7 embed debug info
# GS- disables security cookies (canaries)
# /NXCOMPAT:NO makes the executable incompatible with DEP (32-bits only!)
# /FIXED disables pie
# /CETCOMPAT:NO disabled Control-flow Enhancement Technology
VS_CFLAGS := /Od /Wall /Zi /GS-
VS_LDFLAGS := /NXCOMPAT:NO /FIXED /CETCOMPAT:NO

.PHONY: all clean gcc vs

all: gcc vs shellcode32.bin

clean:
	rm -rf $(TARGETS_GCC) $(TARGETS_VS) $(DEBUG_FILES)

gcc: $(TARGETS_GCC)

vs: $(TARGETS_VS)

include ../common/c_rules.makefile

shellcode32.bin: shellcode32.asm
	nasm -f bin -o $@ $<
