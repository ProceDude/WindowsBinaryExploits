#include <cstdio>

#ifndef WIN32_LEAN_AND_MEAN
#define WIN32_LEAN_AND_MEAN
#endif //WIN32_LEAN_AND_MEAN
#ifndef VC_EXTRALEAN
#define VC_EXTRALEAN
#endif //VC_EXTRALEAN
#include <windows.h>

#include "intel_driver.hpp"

// main
int main() {
	// to see output before BSOD, hopefully
	setvbuf(stdin, 0, _IONBF, 0);
	setvbuf(stdout, 0, _IONBF, 0);
	setvbuf(stderr, 0, _IONBF, 0);


	puts("loading Intel driver...");
	HANDLE hIntel = intel_driver::Load();
	if (!hIntel || INVALID_HANDLE_VALUE == hIntel) {
		puts("failed to load.");
		return 1;
	}
	puts("loaded Intel driver");

	// playground

	char c;
	printf("Free leak: ntoskrnl base is %llx\n", intel_driver::ntoskrnlAddr);
	puts("Enter a char, then press enter to unload");
	puts("Don't ctrl+c or the driver will never unload!");
	scanf("%c", &c);


	puts("unloading Intel driver...");
	intel_driver::Unload(hIntel);
	puts("unloaded Intel driver");

	return 0;
}
