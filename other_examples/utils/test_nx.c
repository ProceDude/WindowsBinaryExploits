#include <stdio.h>
#include <stdint.h>
#include <string.h>

#include <windows.h>

typedef void(*qwakCall)(void);
void qwak(void) {
	puts("Qwak!");
}

int main(void) {
	unsigned char executableBuffer[32];
	unsigned char *ptr = executableBuffer;
	qwakCall functionView = (qwakCall) executableBuffer;
	DWORD oldProtect;
	
	/* put instruction in executableBuffer:
	 * mov eax/rax, qwak
	 * jmp eax/rax
	 */
	if (8 == sizeof(void *)) {
		*(ptr++) = 0x48; // rex prefix
	}
	*(ptr++) = 0xB8; // mov eax, imm32
	*(void **) ptr = qwak;
	ptr += sizeof(void *);
	*(uint16_t *) ptr = 0xe0ff; // jmp *ax
	FlushInstructionCache(0, executableBuffer, 32); // not sure it's needed

	MEMORY_BASIC_INFORMATION info;
	memset(&info, 0, sizeof(info));

	//VirtualProtect(executableBuffer, 32, PAGE_EXECUTE_READWRITE, &oldProtect);

	printf("Some constant's values: PAGE_READWRITE = %d, PAGE_EXECUTE_READWRITE = %d\n", PAGE_READWRITE, PAGE_EXECUTE_READWRITE);

	VirtualQuery(executableBuffer, &info, sizeof(info));
	printf("Initial stack protection: %lu\n", info.Protect);

	puts("A duck will tell you if the stack is executable:");
	functionView();
	
	puts("Now VirtualProtect-ing the stack as PAGE_READWRITE");
	VirtualProtect(executableBuffer, 32, PAGE_READWRITE, &oldProtect);
	printf("Old stack protection reported by VirtualProtect: %lu\n", oldProtect);

	VirtualQuery(executableBuffer, &info, sizeof(info));
	printf("VirtualQuery says the stack is now: %lu\n", info.Protect);

	puts("A duck will tell you if the stack is executable:");
	functionView();

	puts("End of main reached with no crashes");
	return 0;
}
